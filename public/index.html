<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Socket Connection Status</title>
  </head>
  <body>
    <h1>Socket Connection Status</h1>
    <p id="status">Enter your name and connect:</p>
    <input type="text" id="name" placeholder="Your name" />
    <button id="connectBtn" style="display: none">Connect</button>
    <button id="disconnectBtn" style="display: none">Disconnect</button>
    <p id="statusText"></p>
    <script>
      let worker;
      let visibilityChangeEvent;

      function initWorker(name) {
        worker = new Worker('worker.js');
        worker.postMessage({ type: 'set name', name });

        worker.onmessage = (e) => {
          const { type, data } = e.data;
          if (type === 'connection count') {
            document.getElementById(
              'statusText',
            ).innerText = `Current connections: ${data}`;
          } else if (type === 'connect') {
            document.getElementById('statusText').innerText =
              'Socket connected!';
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('disconnectBtn').style.display = 'block';
            document.getElementById('name').disabled = true;
          } else if (type === 'disconnect') {
            document.getElementById('statusText').innerText =
              'Socket disconnected!';
            document.getElementById('connectBtn').style.display = 'block';
            document.getElementById('disconnectBtn').style.display = 'none';
          } else if (type === 'reconnect_attempt') {
            document.getElementById('statusText').innerText = 'Reconnecting...';
          } else if (type === 'reconnect_error') {
            document.getElementById(
              'statusText',
            ).innerText = `Reconnection error: ${data}`;
          } else if (type === 'reconnect_failed') {
            document.getElementById('statusText').innerText =
              'Reconnection failed.';
          }
        };

        // Start long polling
        startLongPolling();
      }

      function handleVisibilityChange() {
        if (document.hidden) {
          worker.postMessage({ type: 'page hidden' });
        } else {
          worker.postMessage({ type: 'page visible' });
        }
      }

      document.getElementById('name').addEventListener('input', () => {
        const name = document.getElementById('name').value;
        document.getElementById('connectBtn').style.display = name
          ? 'block'
          : 'none';
      });

      document.getElementById('connectBtn').addEventListener('click', () => {
        const name = document.getElementById('name').value;
        if (name) {
          initWorker(name);
          visibilityChangeEvent = handleVisibilityChange;
          document.addEventListener('visibilitychange', visibilityChangeEvent);
        }
      });

      document.getElementById('disconnectBtn').addEventListener('click', () => {
        if (worker) {
          worker.terminate();
          document.getElementById('statusText').innerText =
            'Socket disconnected!';
          document.getElementById('connectBtn').style.display = 'block';
          document.getElementById('disconnectBtn').style.display = 'none';
          document.getElementById('name').disabled = false;
          document.removeEventListener(
            'visibilitychange',
            visibilityChangeEvent,
          );
        }
      });

      function startLongPolling() {
        setInterval(() => {
          fetch('/poll')
            .then((response) => response.text())
            .then((data) => console.log(data));
        }, 10000); // Poll every 10 seconds
      }
    </script>
  </body>
</html>
